<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

<script>
 const tableName = 'input';

 async function query(tableElement, sqlQuery) {
     // First, convert HTML table to array of objects
     function tableToJson(table) {
         const headers = [...table.querySelectorAll('th')].map(th => th.textContent.trim());
         const rows = [...table.querySelectorAll('tr')].slice(1);

         return rows.map(row => {
             const cells = [...row.querySelectorAll('td')];
             return headers.reduce((obj, header, i) => {
                 obj[header] = cells[i] ? cells[i].innerHTML.trim() : null;
                 return obj;
             }, {});
         });
     }

     // Convert result back to HTML table
     function createResultTable(results) {
         const table = document.createElement('table');

         // Copy class attribute from input table
         if (tableElement.hasAttribute('class')) {
             table.setAttribute('class', tableElement.getAttribute('class'));
         }

         // Create header row if we have results
         if (results.length > 0) {
             const thead = document.createElement('thead');
             const headerRow = document.createElement('tr');

             Object.keys(results[0]).forEach(key => {
                 const th = document.createElement('th');
                 th.innerHTML = key;
                 headerRow.appendChild(th);
             });

             thead.appendChild(headerRow);
             table.appendChild(thead);
         }

         // Create data rows
         const tbody = document.createElement('tbody');
         results.forEach(row => {
             const tr = document.createElement('tr');
             Object.values(row).forEach(value => {
                 const td = document.createElement('td');
                 td.innerHTML = value;
                 tr.appendChild(td);
             });
             tbody.appendChild(tr);
         });

         table.appendChild(tbody);
         return table;
     }


     try {
         // Initialize SQL.js
         const SQL = await initSqlJs({
             locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
         });

         // Create a database
         const db = new SQL.Database();

         // Convert table to JSON
         const data = tableToJson(tableElement);

         // Create table and insert data
         if (data.length > 0) {
             // Generate CREATE TABLE statement
             const columns = Object.keys(data[0])
                                   .map(col => `"${col}" TEXT`)
                                   .join(', ');

             db.run(`CREATE TABLE ${tableName} (${columns})`);

             // Insert data
             data.forEach(row => {
                 const columns = Object.keys(row).map(col => `"${col}"`).join(', ');
                 const values = Object.values(row).map(val => `'${val}'`).join(', ');
                 db.run(`INSERT INTO ${tableName} (${columns}) VALUES (${values})`);
             });

             // Execute query
             const results = db.exec(sqlQuery);

             // Convert results to array of objects
             if (results.length > 0) {
                 const columns = results[0].columns;
                 const rows = results[0].values.map(row => {
                     return columns.reduce((obj, col, i) => {
                         obj[col] = row[i];
                         return obj;
                     }, {});
                 });

                 // Convert to HTML table and return
                 return createResultTable(rows);
             }
         }

         // Return empty table if no results
         return createResultTable([]);

     } catch (error) {
         console.error('Error executing query:', error);
         const errorTable = document.createElement('table');
         // Copy class attribute from input table
         if (tableElement.hasAttribute('class')) {
             errorTable.setAttribute('class', tableElement.getAttribute('class'));
         }
         errorTable.innerHTML = `<tr><td>Error executing query: ${error.message}</td></tr>`;
         return errorTable;
     }
 }

 function initializeTableQueries() {
     // Find all tables in the document
     const tables = document.getElementsByTagName('table');

     Array.from(tables).forEach((table, index) => {
         // Create container for query controls
         const container = document.createElement('div');
         container.className = 'field has-addons';

         // Create input control wrapper
         const inputControl = document.createElement('div');
         inputControl.className = 'control is-expanded';

         // Create input field
         const input = document.createElement('input');
         input.type = 'text';
         input.className = 'input';
         input.placeholder = `Enter SQL query. the following table name is ${tableName}...`;

         // Create button control wrapper
         const buttonControl = document.createElement('div');
         buttonControl.className = 'control';

         // Create query button
         const button = document.createElement('button');
         button.className = 'button';
         button.textContent = 'Run Query';

         // Create error message container
         const errorContainer = document.createElement('div');
         errorContainer.className = 'help is-danger mt-2';

         // Assemble the components
         inputControl.appendChild(input);
         buttonControl.appendChild(button);
         container.appendChild(inputControl);
         container.appendChild(buttonControl);

         // Create a wrapper div for the whole component
         const wrapper = document.createElement('div');
         wrapper.className = 'mb-4';
         wrapper.appendChild(container);
         wrapper.appendChild(errorContainer);

         // Insert wrapper before table
         table.parentNode.insertBefore(wrapper, table);

         // Keep track of the result table if created
         let resultTable = null;

         // Add event listener for input changes
         input.addEventListener('input', (e) => {
             if (e.target.value.trim() === '') {
                 // Show original table
                 table.style.display = '';

                 // Remove result table if it exists
                 if (resultTable) {
                     resultTable.remove();
                     resultTable = null;
                 }

                 // Clear error message
                 errorContainer.textContent = '';
             }
         });

         // Add event listener for button click
         button.addEventListener('click', async () => {
             const sqlQuery = input.value.trim();

             if (sqlQuery === '') {
                 errorContainer.textContent = 'Please enter a SQL query';
                 return;
             }

             try {
                 // Show loading state
                 button.classList.add('is-loading');

                 // Remove previous result table if it exists
                 if (resultTable) {
                     resultTable.remove();
                 }

                 // Execute query
                 resultTable = await query(table, sqlQuery);

                 // Hide original table
                 table.style.display = 'none';

                 // Insert result table after the wrapper
                 wrapper.after(resultTable);

                 // Clear error message
                 errorContainer.textContent = '';

             } catch (error) {
                 errorContainer.textContent = `Error: ${error.message}`;
                 console.error('Query error:', error);

                 // Show original table
                 table.style.display = '';

                 // Remove result table if it exists
                 if (resultTable) {
                     resultTable.remove();
                     resultTable = null;
                 }
             } finally {
                 // Remove loading state
                 button.classList.remove('is-loading');
             }
         });
     });
 }

 // Initialize when DOM is ready
 if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initializeTableQueries);
 } else {
     initializeTableQueries();
 }
</script>
